<!doctype html>
<html>
    <head>
        <script src="https://s3.amazonaws.com/stitch-sdks/js/library/v3/stable/stitch.min.js"></script>
        <script>
            const clientPromise = stitch.StitchClientFactory.create('blog_comments-dusdh');

            let client;
            let db;

            function getNowFormatDate() {
                var date = new Date();
                var seperator1 = "-";
                var seperator2 = ":";
                var month = date.getMonth() + 1;
                var strDate = date.getDate();
                if (month >= 1 && month <= 9) {
                    month = "0" + month;
                }
                if (strDate >= 0 && strDate <= 9) {
                    strDate = "0" + strDate;
                }
                var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate
                                + " " + date.getHours() + seperator2 + date.getMinutes()
                                + seperator2 + date.getSeconds();
                return currentdate;
            }

            function displayCommentsOnLoad() {
                clientPromise.then(stitchClient => {
                    client = stitchClient;
                    db = client.service('mongodb', 'mongodb-atlas').db('blog');
                    return client.login().then(displayComments)
                });
            }

            function displayComments() {
                db.collection('comments').find({}).limit(1000).execute().then(docs => {
                    var html = docs.map(c => "<div>" + c.time + ' || ' + c.comment + "</div>").join("");
                    document.getElementById("comments").innerHTML = html;
                });
            }

            function addComment() {
                var foo = document.getElementById("new_comment");
                var timestamp = getNowFormatDate();
                
                if (foo.value.substring(0,3) === "DEL") {
                    timestamp = foo.value.substring(4);
                    db.collection("comments").deleteOne({time: timestamp}).then(displayComments);
                }
                else {
                    db.collection("comments").insertOne({owner_id : client.authedId(), time: timestamp, comment: foo.value}).then(displayComments);
                    foo.value = "";
                }
            }

        </script>
    </head>

    <body onLoad="displayCommentsOnLoad()">
        <h3>Conversition with Capi !!!</h3>
        <div id="content">
            I will keep improving the UI... I know it's not pretty.
        </div>
        <hr>
        <div id="comments"></div>
        <hr>
        New message: <input id="new_comment" size=100><input type="submit" value="Send" onClick="addComment()">

    </body>
</html>